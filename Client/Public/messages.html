<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Pigeon</title>
        <style>
            body {
                display: flex;
                margin: 0;
                height: 100vh;
            }
    
            #conversationList {
                width: 20%;
                background-color: #f0f0f0;
                padding: 20px;
                box-sizing: border-box;
            }
    
            #conversationDetails {
                flex: 1;
                padding: 20px;
                box-sizing: border-box;
            }
    
            #newConversationButton {
                margin-top: 10px;
                padding: 10px;
            }
        </style>
    </head>
<body>
    <div id="conversationList">
        <h2>Conversations</h2>
        <ul id="conversationLinks">
        </ul>
        <form id="conversationForm">
            <label for="message">Start conversation with:</label>
            <input type="text" id="userId" name="userId" placeholder="Write username here" required>
            <button type="button" onclick="startNewConversation()">Start</button>
        </form>
    </div>

    <div id="conversationDetails">
        <h2>Conversation Details</h2>
        <div id="conversationContent">
        </div>

        <form id="messageForm">
            <label for="message">Enter your message:</label>
            <input type="text" id="message" name="message" required>
            <button type="button" onclick="sendMessage()">Send</button>
        </form>
    </div>

    <script>
        const username = sessionStorage.getItem('username');
        let currentConversationId = '';

        function sendMessage() {
            const messageInput = document.getElementById('message');
            const message = messageInput.value;
            const conversationId = currentConversationId;

            const messageData = {
                conversationId: conversationId,
                sender: sessionStorage.getItem('username'),
                message: message
            };

            console.log('Sending message: ', messageData);

            fetch('http://127.0.0.1:3000/newMessage', {
                method: 'PATCH',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(messageData)
            })
            .then(response => {
                if (response.ok) {
                console.log('Message sent successfully!');
                messageInput.value = '';
                loadConversation(conversationId);
                } else {
                console.error('Failed to send message.');
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
            });
        }

        function loadConversations() {
            const conversationLinks = document.getElementById('conversationLinks');
            conversationLinks.innerHTML = '';

            const serverUrl = 'http://' + 'localhost' + ':' + 3000 + '/getAllConversations?username=' + sessionStorage.getItem('username');
            console.log(`Sending request to: ${serverUrl}`);

            fetch(serverUrl)
                .then(response => response.json())
                .then(conversations => {
                    conversations.forEach(conversation => {
                        const listItem = document.createElement('li');
                        const link = document.createElement('a');
                        link.href = '#';
                        link.onclick = () => loadConversation(conversation.id);
                        const users = conversation.users.join(', ');
                        link.textContent = users;
                        listItem.appendChild(link);
                        conversationLinks.appendChild(listItem);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching conversations:', error);
                    });
        }

        function loadConversation(conversationId) {
            const conversationContent = document.getElementById('conversationContent');
            conversationContent.innerHTML = 'Loading conversation...';
            currentConversationId = conversationId;

            const serverUrl = 'http://' + 'localhost' + ':' + 3000 + '/getConversation?id=' + conversationId;
            console.log(`Sending request to: ${serverUrl}`);

            fetch(serverUrl)
                .then(response => response.json())
                .then(messages => {
                conversationContent.innerHTML = '';
                messages.forEach(message => {
                    const messageElement = document.createElement('div');
                    const senderAndTimeElement = document.createElement('div');
                    const messageTextElement = document.createElement('div');

                    senderAndTimeElement.textContent = `Sender: ${message.sender}, Time: ${message.time}`;
                    messageTextElement.textContent = `${message.message}`;

                    messageElement.appendChild(senderAndTimeElement);
                    messageElement.appendChild(messageTextElement);

                    messageTextElement.style.fontSize = '1.2em';
                    messageTextElement.style.marginTop = '5px';
                    messageTextElement.style.marginBottom = '7px';

                    conversationContent.appendChild(messageElement);
                   });
                })
                .catch(error => {
                console.error('Error fetching conversation:', error);
                conversationContent.innerHTML = 'Error loading conversation.';
                });
        }

        function startNewConversation() {
            const userIdInput = document.getElementById('userId');
            const userId = userIdInput.value;

            const convData = {
                fromUsername: sessionStorage.getItem('username'),
                toUsername: userId
            };

            console.log('Starting new conversation: ', convData);

            fetch('http://127.0.0.1:3000/newConversation', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(convData)
            })
            .then(response => {
                if (response.ok) {
                console.log('Conversation started successfully!');
                userId.value = '';
                loadConversations();
                } else {
                alert("User doesn't exists")
                console.error('Failed to send message.');
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
            });
        }

        window.onload = loadConversations;
    </script>
</body>
</html>